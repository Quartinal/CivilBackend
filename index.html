<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Google Docs</title>
        <link rel="icon" type="image/x-icon" href="https://ssl.gstatic.com/docs/doclist/images/mediatype/icon_1_document_x16.png">
        <link rel="stylesheet" type="text/css" href="./main.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </head>

    <body>

        <div class="header">
            <a href="/">Civil<h2 class="logo">Proxy</h2></a>

            <div class="searchbar">
                <input type="text" placeholder="Search" class="urlInput">
            </div>
        </div>

        <ul class="suggestions"></ul>

        <iframe src="" width="20%" height="40%" class="ggIf"></iframe>

        <script type="text/javascript">
            window.addEventListener('load', () => {
                const win = window.open();
                win.document.head.innerHTML = document.head.innerHTML;
                win.document.body.innerHTML = document.body.innerHTML;
            });

            const urlInput = document.querySelector(".urlInput"),
                suggestionsMenu = document.querySelector(".suggestions");

            urlInput.addEventListener("input", () => {
                suggestionsMenu.style.display = 'flex';
                const e = urlInput.value.trim();
                if (e.startsWith("http://") || e.startsWith("https://")) {
                    suggestionsMenu.textContent = e;
                    return;
                }
                if (e == "") suggestionsMenu.style.display = 'none';
                let debounceTimeout;
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => {
                    getSearchSuggestions(e)
                        .then((e) => {
                            suggestionsMenu.innerHTML = "";
                            if (e.length) {
                                suggestionsMenu.innerHTML = e
                                    .map((el) => `<li><a>${el}</a><i class="fa-solid fa-splotch" title="Open direct blob URL for: google.com/${encodeURIComponent(el)}"></i><i class="fa-solid fa-database" title="Open direct data URL for: google.com/${encodeURIComponent(el)}"></i><i class="fa-solid fa-magnifying-glass" title="Search Google for: ${el}"></i></li>`)
                                    .join("");
                                suggestionsMenu.addEventListener(
                                    "click",
                                    (event) => {
                                        if ("A" === event.target.tagName) {
                                            let t = document.querySelector('.ggIf');
                                            t.src = `https://www.google.com/search?q=${encodeURIComponent(e)}`;
                                            t.style.display = 'block';
                                        }
                                    }, {
                                        once: true
                                    }
                                );
                            }
                        })
                        .catch((error) => console.error(error));
                }, 300);
            });

            const getSearchSuggestions = (e) =>
                fetch(`https://corsproxy.io/?https://clients1.google.com/complete/search?hl=en&output=toolbar&q=${encodeURIComponent(
                            e
                        )}`, {
                    mode: "cors",
                    method: "GET",
                })
                .then((res) => {
                    if (!res.ok) throw Error(`Unable to find a match for response status: ${res.status}`);
                    return res.text();
                })
                .then((data) => {
                    let parser = new DOMParser(),
                        xmlDoc = parser.parseFromString(data, "text/xml"),
                        suggestions = [];

                    for (let i = 0; i < xmlDoc.getElementsByTagName("suggestion").length; i++) suggestions.push(xmlDoc.getElementsByTagName("suggestion")[i].getAttribute("data"));

                    return suggestions.slice(0, 10);
                })
                .catch((error) => (console.error(error), []));
        </script>
    </body>
</html>